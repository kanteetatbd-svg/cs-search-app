import streamlit as st
import pandas as pd
import gspread
from google.oauth2.service_account import Credentials

st.set_page_config(page_title="CS Case Intelligence & Editor", page_icon="üìù", layout="wide")

# --- üéØ ‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô Dropdown ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏û‡∏µ‡πà ---
# ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ
DROPDOWN_CONFIG = {
    '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': ['‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î'],
    '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏™': ['ID', 'IMEI', '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
}

# --- 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ---
@st.cache_resource
def get_sheets_client():
    try:
        scopes = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']
        creds = Credentials.from_service_account_file('key.json', scopes=scopes)
        return gspread.authorize(creds)
    except Exception as e:
        st.error(f"‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠: {e}")
        return None

# --- 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
@st.cache_data(ttl=60)
def load_data_for_edit():
    gc = get_sheets_client()
    if not gc: return {}
    sh = gc.open('Copy of ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏™2025V1')
    worksheets = sh.worksheets()
    all_data = {}
    
    for ws in worksheets:
        data = ws.get_all_values()
        if not data: continue
        df = pd.DataFrame(data)
        
        # ‡∏£‡∏∞‡∏ö‡∏ö Smart Header ‡∏´‡∏≤‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        header_idx = 0
        max_cols = 0
        for i in range(min(15, len(df))):
            count = sum(1 for x in df.iloc[i] if str(x).strip() != "")
            if count > max_cols:
                max_cols = count
                header_idx = i
        
        headers = df.iloc[header_idx].tolist()
        df['sheet_row'] = df.index + 1 
        df.columns = headers + ['sheet_row']
        df = df.iloc[header_idx+1:].reset_index(drop=True)
        all_data[ws.title] = df
    return all_data

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å ---
st.title("üìù CS Case Intelligence & Editor")
master_data = load_data_for_edit()

search_val = st.text_input("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ID ‡∏´‡∏£‡∏∑‡∏≠ IMEI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:")

if search_val:
    q = search_val.strip().lower()
    for title, df in master_data.items():
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        mask = df.astype(str).apply(lambda row: row.str.lower().str.contains(q, na=False).any(), axis=1)
        res = df[mask]
        
        if not res.empty:
            st.markdown(f"### üìÇ ‡πÅ‡∏ó‡πá‡∏ö: {title}")
            st.dataframe(res.drop(columns=['sheet_row']), use_container_width=True, hide_index=True)
            
            # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
            with st.expander(f"üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö {title}", expanded=True):
                col1, col2, col3 = st.columns([1, 1, 0.5])
                
                # 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ
                selectable_cols = [c for c in res.columns if c != 'sheet_row']
                target_col = col1.selectbox(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ({title})", selectable_cols, key=f"col_{title}")
                
                # 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Dropdown ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
                if target_col in DROPDOWN_CONFIG:
                    new_val = col2.selectbox(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {target_col}:", DROPDOWN_CONFIG[target_col], key=f"val_{title}")
                else:
                    new_val = col2.text_input(f"‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {target_col}:", key=f"input_{title}")
                
                # 3. ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                if col3.button(f"üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ({title})", key=f"btn_{title}"):
                    row_in_sheet = int(res.iloc[0]['sheet_row'])
                    with st.spinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'):
                        try:
                            gc = get_sheets_client()
                            sh = gc.open('Copy of ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ñ‡∏™2025V1')
                            ws = sh.worksheet(title)
                            
                            # ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Sheets
                            current_headers = ws.row_values(1) # ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á
                            c_idx = current_headers.index(target_col) + 1
                            
                            ws.update_cell(row_in_sheet, c_idx, new_val)
                            st.success(f"‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç {target_col} ‡πÄ‡∏õ‡πá‡∏ô '{new_val}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                            st.cache_data.clear() # ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                            # st.rerun() # ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        except Exception as e:
                            st.error(f"‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")

st.sidebar.info("üí° **‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Dropdown:** ‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô `DROPDOWN_CONFIG` ‡∏ï‡πâ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏£‡∏±‡∏ö")
